#!/usr/bin/env php
<?php

/**
 * @file
 * Warms the cache for the Drupal CMS installation.
 * 
 * This script executes a Drupal page request to warm the cache. It suppresses
 * normal output but detects and reports errors, returning appropriate exit codes.
 */

ini_set('display_errors', '0');

$request_uri = $argv[1] ?? '/';

// Check if this is the internal subprocess execution
if (isset($argv[1]) && $argv[1] === '--internal') {
  // Internal execution - bootstrap Drupal and execute the request
  $request_uri = $argv[2] ?? '/';
  
  chdir(dirname(__DIR__) . '/web');
  $_SERVER['SERVER_NAME'] = 'localhost';
  $_SERVER['SERVER_PORT'] = '80';
  $_SERVER['SCRIPT_NAME'] = '/index.php';
  $_SERVER['REQUEST_URI'] = $request_uri;
  
  // Suppress normal Drupal output
  ob_start(fn($buffer, $phase) => TRUE, 1);
  
  require 'index.php';
  ob_end_clean();
  exit;
}

// Main execution - run Drupal in a subprocess to capture all output
$command = sprintf(
  'php %s --internal %s 2>&1',
  escapeshellarg(__FILE__),
  escapeshellarg($request_uri)
);

exec($command, $output_lines, $exit_code);
$output = implode("\n", $output_lines);

// Any output indicates an error (since normal output is suppressed)
if (!empty($output) || $exit_code !== 0) {
  echo "$output\n";
  exit($exit_code ?: 255);
}

echo "Warmed cache for $request_uri\n";
